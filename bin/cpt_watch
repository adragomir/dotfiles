#!/bin/bash

username=adragomi
password=$(security find-generic-password -a adragomi -s adragomi-adobe -w)

jobid=$1

token=$(curl -s --location --request POST 'https://cpt-selfservice-api.corp.ethos10-prod-va7.ethos.adobe.net/api/token-auth' --header 'Content-Type: application/json' --data-raw "{ \"username\" : \"$username\", \"password\": \"$password\"}"  | jq ".token" -r )

while true; do
  result=$(curl -s --location --request GET 'https://cpt-selfservice-api.corp.ethos10-prod-va7.ethos.adobe.net/api/job_status?job_id=${jobid}' --header 'Content-Type: application/json' --header "Authorization: Token $token" --data-raw "")
  echo $result

  status=$(echo $result | jq -r '.status')
  [[ $status == "SUCCESS" ]] && break
done
