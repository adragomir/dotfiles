#!/bin/bash

while getopts "n:" flag; do
    case "${flag}" in
        n) optname=${OPTARG};;
    esac
done

log() {
  #echo "${1}" >/dev/null
  echo "${1}"
}

target=""
if [[ $# -eq 0 ]]; then
  target=$(pwd)
else
  if [[ "${1}" == "." ]]; then
    target=$(pwd)
  else
    target="${1}"
  fi
fi
# Get absolute path
if [ -e "$target" ]; then
  target=$(cd "$(dirname "$target")" 2>/dev/null && pwd -P)/"$(basename "$target")"
fi
# Get git root or fallback to target directory - use dirname if target is a file
target_dir=$([ -f "$target" ] && dirname "$target" || echo "$target")
git_root=$(cd "$target_dir" 2>/dev/null && git rev-parse --show-toplevel 2>/dev/null)
if [ -n "$git_root" ]; then
  # We're in a git repo
  working_dir="$git_root"
elif [ "$target" = "$HOME" ]; then
  # We're in HOME
  working_dir="$HOME"
else
  # We're in a regular directory
  working_dir="$target_dir"
fi
if [ -f "$target" ]; then
	if [ -n "$git_root" ] && echo "$target" | grep -q "^$git_root/"; then
		rel_path="${target#${git_root}/}"
	else
		rel_path="$target"
	fi
else
	rel_path=""
fi
echo "git_root=${git_root} working=${working_dir} target=${target} rel_path=${rel_path}"

name=${optname:-App}
socket_path="/tmp/neovide${name}.sock"

neovide_is_running=$(osascript -e "application id (\"com.neovide.neovide\") is running")
if [[ "$neovide_is_running" == "false" ]]; then
  if [ -S $socket_path ]; then
    rm -f $socket_path
  fi
fi

if [ ! -S $socket_path ]; then
  /Users/adragomi/Applications/DevelopmentTools/neovide.app/Contents/MacOS/neovide \
  --fork \
  -- --listen ${socket_path} -c "lua do_in_tab('${working_dir}', '${rel_path}')"
else
  /usr/bin/osascript -e 'tell application "Neovide" to activate' &>/dev/null
  log "lua do_in_tab('${working_dir}', '${rel_path}')"
  /opt/homebrew/bin/nvim --server $socket_path --remote-send "<C-\><C-N>:lua do_in_tab('${working_dir}', '${rel_path}')<cr>"
fi

