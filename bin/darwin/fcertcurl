#!/bin/bash

PUPPET_ROOT=$HOME/work/ops/fitbit-puppet

TMPDIR=$(mktemp -d)
#trap "rm -rf $TMPDIR" EXIT
CERT=$PUPPET_ROOT/modules/fitbit_identity/files/tls/$1/certificate.pem
ENCKEY=$PUPPET_ROOT/modules/fitbit_identity/files/tls/$1/key.pem
DECKEY=$TMPDIR/key
openssl smime -decrypt -aes256 -binary -inform der -inkey $HOME/.ssh/hiera_private.key -in $ENCKEY > $DECKEY
CACERT=$PUPPET_ROOT/modules/fitbit_identity/files/tls/$1/certificate.pem

shift

fcurl --cert $CERT --key $DECKEY --cacert $CACERT "$@"
#fcurl --cert $CERT --cacert $CACERT "$@"
