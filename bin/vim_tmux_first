#!/bin/bash

debug=0

if [[ $1 == /* ]]; then
  file=$(printf '%q' "$1")
else
  file=$(pwd)$(printf '%q' "$1")
fi
TMUX=/usr/local/bin/tmux
PSTREE=/usr/local/bin/pstree

for s in `$TMUX list-sessions -F '#{session_name}'` ; do
  for w in `$TMUX list-windows -F '#{window_index}' -t "$s"` ; do
    for p in `$TMUX list-panes -F '#{pane_index}=#{pane_pid}' -t "$w"` ; do
      pane_index="${p%%=*}"
      first_pid="${p##*=}"
      res=$($PSTREE -p $first_pid | egrep "MacOS\/[V]im" >/dev/null ; echo $?)
      if [ "$res" -eq "0" ]; then
        window_pane="${w}.${pane_index}"
        [[ $debug == 1  ]] && echo "$TMUX send-keys -t $window_pane Escape ":e $file" Enter" >> ~/lg
        $TMUX send-keys -t "$window_pane" Escape ":e $file" Enter
        break 3
      fi
    done
  done
done

/usr/bin/osascript <<'EOT'
tell application "System Events" to tell process "iTerm2"
	set frontmost to true
	key code 18 using {command down} -- Command+1
	key code 0 using {control down} -- c-a
	key code 18 -- 1
end tell
EOT

