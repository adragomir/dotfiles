#!/bin/bash

push_only=0
master_branch=master
while getopts ":pb:" opt; do
  case $opt in
    p)
      push_only=1
      ;;
    b)
      master_branch=$OPTARG
      ;;
  esac
done

branch_name="$(git rev-parse --symbolic-full-name --abbrev-ref HEAD)"
IFS=$'\r\n'
commits=($(git rev-list --reverse "${master_branch}..${branch_name}"))

#base=$(git rev-parse master)
base=$master_branch

commits_len=${#commits[@]}

last_issue=""
commit_issue=""
commit_message=""
for (( i=0; i<=$(( $commits_len -1 )); i++ ))
do
  commit_msg=$(git log -1 --pretty=format:%s "${commits[$i]}")
  issue_name=`expr "$commit_msg" : '^\[\([A-Z0-9\-]*\)\]'`
  if [[ "${issue_name}" != "" ]]; then
    if [[ $commit_issue != "" ]]; then
      # we have something to push
      branch_name=$commit_issue
      if [[ "$branch_name" =~ ^[A-Z]*$ ]]; then
        branch_name="$branch_name-$(echo -n "$commit_message" | sha1sum | cut -f1 -d" " | cut -c1-8)"
      fi
      echo "git push -f origin ${last_commit}:refs/heads/$branch_name"
      if [[ $push_only == 0  ]]; then
        echo "hub pull-request -f -m \"${commit_message}\" -b $base -h $branch_name"
      fi
      base=$branch_name
    fi
    commit_issue="${issue_name}"
    commit_message="${commit_msg}"
  fi
  last_commit="${commits[$i]}"
done

if [[ $commit_issue != "" ]]; then
  # we have something to push
  branch_name=$commit_issue
  if [[ "$branch_name" =~ ^[A-Z]*$ ]]; then
    branch_name="$branch_name-$(echo -n "$commit_message" | sha1sum | cut -f1 -d" " | cut -c1-8)"
  fi
  echo "git push -f origin ${last_commit}:refs/heads/$branch_name"
  if [[ $push_only == 0  ]]; then
    echo "hub pull-request -f -m \"${commit_message}\" -b $base -h $branch_name"
  fi
fi

