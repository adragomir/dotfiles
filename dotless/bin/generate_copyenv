#!/usr/bin/env ruby

prefix = <<EOD
#!/bin/sh

if [ -z "$1" ] ; then
  echo "usage: copyenv <ssh remote spec>"
  echo "SSHPORT=1234   set remote ssh port (default 22)"
  exit 1
fi

TMP=/tmp/$$

if [ -z "$SSHPORT" ]
then SSHPORT=22
fi

#######################################################################

if [ -f ~/.ssh/id_rsa.pub ]
then PUB=~/.ssh/id_rsa.pub
elif [ -f ~/.ssh/id_dsa.pub ]
then PUB=~/.ssh/id_dsa.pub
fi

if [ -f $PUB ] ; then
  echo "if [ ! -d ~/.ssh ] ; then mkdir ~/.ssh; chmod 700 ~/.ssh; fi" > $TMP
  P=`cat $PUB`
  echo "echo '$P' >> ~/.ssh/authorized_keys" >> $TMP
  scp -P $SSHPORT $TMP $1:$TMP
  ssh -p $SSHPORT $1 sh $TMP
fi

#######################################################################

scp -P $SSHPORT $0 $1:copyenv

#######################################################################
EOD
